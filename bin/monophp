#!/bin/bash

# MonoPHP Project Generator
# Usage: monophp new <project-name>

set -e

MONOPHP_REPO="https://github.com/wilihandarwo/monophp.git"
VERSION="2.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_logo() {
    echo -e "${BLUE}"
    echo "  __  __                   _____  _    _ _____  "
    echo " |  \/  |                 |  __ \| |  | |  __ \ "
    echo " | \  / | ___  _ __   ___ | |__) | |__| | |__) |"
    echo " | |\/| |/ _ \| '_ \ / _ \|  ___/|  __  |  ___/ "
    echo " | |  | | (_) | | | | (_) | |    | |  | | |     "
    echo " |_|  |_|\___/|_| |_|\___/|_|    |_|  |_|_|     "
    echo -e "${NC}"
    echo "  Single-file PHP Application Generator v${VERSION}"
    echo ""
}

show_help() {
    print_logo
    echo "Usage: monophp <command> [options]"
    echo ""
    echo "Commands:"
    echo "  new <name>     Create a new MonoPHP project"
    echo "  list           List available variants"
    echo "  update         Update MonoPHP CLI to latest version"
    echo "  help           Show this help message"
    echo "  version        Show version"
    echo ""
    echo "Examples:"
    echo "  monophp new myapp"
    echo "  monophp list"
    echo "  monophp update"
    echo ""
}

list_variants() {
    print_logo
    echo "Available MonoPHP Variants:"
    echo ""

    local manifest_url="https://raw.githubusercontent.com/wilihandarwo/monophp/main/variants/manifest.json"

    if command -v jq &> /dev/null; then
        local manifest=$(curl -sL "$manifest_url" 2>/dev/null)
        if [[ -n "$manifest" ]]; then
            echo "$manifest" | jq -r '.variants[] | "  \(.id)\n    \(.name) - \(.description)\n"'
        else
            echo "  (Unable to fetch variants list)"
        fi
    else
        echo "  emailpass-sidebar"
        echo "    Email & Password (Sidebar) - Traditional auth with sidebar layout"
        echo ""
        echo "  emailpass-topbar"
        echo "    Email & Password (Topbar) - Traditional auth with topbar layout"
        echo ""
        echo "  googleoauth"
        echo "    Google OAuth - OAuth authentication with Google"
        echo ""
        echo "  noauth"
        echo "    No Authentication - Minimal variant without auth"
        echo ""
        echo "  newstructure-email"
        echo "    New Structure (Experimental) - New code structure with email auth"
        echo ""
    fi
}

show_version() {
    echo "MonoPHP Generator v${VERSION}"
}

update_cli() {
    print_logo
    echo -e "${YELLOW}➜${NC} Updating MonoPHP CLI..."
    echo ""

    local install_dir="$HOME/.monophp/bin"
    local cli_url="https://raw.githubusercontent.com/wilihandarwo/monophp/main/bin/monophp"

    # Download latest version
    if curl -sL "$cli_url" -o "$install_dir/monophp.tmp"; then
        chmod +x "$install_dir/monophp.tmp"
        mv "$install_dir/monophp.tmp" "$install_dir/monophp"
        echo -e "${GREEN}✓ MonoPHP CLI updated successfully!${NC}"
        echo ""
        echo -e "Run ${BLUE}monophp version${NC} to check the new version."
    else
        echo -e "${RED}Error: Failed to download update${NC}"
        rm -f "$install_dir/monophp.tmp"
        exit 1
    fi
    echo ""
}

# Interactive menu with arrow key navigation
# Result is stored in SELECTED_OPTION variable
select_option() {
    local options=("$@")
    local selected=0
    local count=${#options[@]}

    # Hide cursor
    tput civis

    # Ensure cursor is restored on exit
    trap 'tput cnorm' EXIT

    while true; do
        # Print options
        for i in "${!options[@]}"; do
            if [[ $i -eq $selected ]]; then
                echo -e "  ${GREEN}▸ ${options[$i]}${NC}"
            else
                echo -e "    ${options[$i]}"
            fi
        done

        # Read single key
        read -rsn1 key

        # Handle arrow keys (escape sequences)
        if [[ $key == $'\x1b' ]]; then
            read -rsn2 key
            case $key in
                '[A') # Up arrow
                    ((selected--)) || true
                    [[ $selected -lt 0 ]] && selected=$((count - 1))
                    ;;
                '[B') # Down arrow
                    ((selected++)) || true
                    [[ $selected -ge $count ]] && selected=0
                    ;;
            esac
        elif [[ $key == "" ]]; then  # Enter key
            break
        fi

        # Move cursor up to redraw
        tput cuu $count
    done

    # Show cursor
    tput cnorm

    # Store result in global variable (avoids set -e issues with return codes)
    SELECTED_OPTION=$selected
}

create_project() {
    local project_name="$1"
    local target_dir="$(pwd)/${project_name}"
    local temp_dir=$(mktemp -d)

    # Validate project name
    if [[ -z "$project_name" ]]; then
        echo -e "${RED}Error: Project name is required${NC}"
        echo "Usage: monophp new <project-name>"
        exit 1
    fi

    # Check if project name is valid (alphanumeric, hyphens, underscores)
    if [[ ! "$project_name" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
        echo -e "${RED}Error: Invalid project name${NC}"
        echo "Project name must start with a letter and contain only letters, numbers, hyphens, or underscores"
        exit 1
    fi

    # Check if directory already exists
    if [[ -d "$target_dir" ]]; then
        echo -e "${RED}Error: Directory '${project_name}' already exists${NC}"
        exit 1
    fi

    # Check for git
    if ! command -v git &> /dev/null; then
        echo -e "${RED}Error: git is required but not installed${NC}"
        exit 1
    fi

    print_logo
    echo -e "${GREEN}Creating new MonoPHP project: ${project_name}${NC}"
    echo ""

    # Clone from GitHub to temp directory
    echo -e "${YELLOW}➜${NC} Downloading MonoPHP template..."
    git clone --quiet --depth 1 "$MONOPHP_REPO" "$temp_dir/monophp"

    # Copy the framework structure (complete website template)
    cp -r "$temp_dir/monophp/framework" "$target_dir"

    # Prompt for authentication variant
    echo ""
    echo -e "${YELLOW}Select authentication method:${NC}  ${BLUE}(↑↓ to move, Enter to select)${NC}"
    echo ""

    select_option "Email & Password (Sidebar)" "Email & Password (Topbar)" "Google OAuth" "No Auth"
    auth_choice=$SELECTED_OPTION

    echo ""
    auth_label="Email & Password (Sidebar)"  # Default
    local variant_id=""
    case $auth_choice in
        0)
            auth_label="Email & Password (Sidebar)"
            variant_id="emailpass-sidebar"
            ;;
        1)
            auth_label="Email & Password (Topbar)"
            variant_id="emailpass-topbar"
            ;;
        2)
            auth_label="Google OAuth"
            variant_id="googleoauth"
            ;;
        3)
            auth_label="No Auth"
            variant_id="noauth"
            ;;
        *)
            variant_id="emailpass-sidebar"
            ;;
    esac

    echo -e "${YELLOW}➜${NC} Using ${auth_label} authentication..."

    # Copy selected variant's index.php to project
    local variant_file="$temp_dir/monophp/variants/$variant_id/index.php"
    if [[ -f "$variant_file" ]]; then
        cp "$variant_file" "$target_dir/public/index.php"
    else
        echo -e "${RED}Error: Variant not found: $variant_id${NC}"
        echo -e "${RED}Please run 'monophp update' to get the latest version${NC}"
        rm -rf "$target_dir" "$temp_dir"
        exit 1
    fi

    # Clean up temp directory
    rm -rf "$temp_dir"

    # Create .env from .env.example
    cp "$target_dir/.env.example" "$target_dir/.env"

    # Replace project-specific values
    echo -e "${YELLOW}➜${NC} Configuring project..."

    # Update database filename in index.php (cross-platform sed)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "s/monophp\.sqlite/${project_name}.sqlite/g" "$target_dir/public/index.php"
        sed -i '' "s/SITE_DOMAIN=localhost:8000/SITE_DOMAIN=${project_name}.test/" "$target_dir/.env"
    else
        sed -i "s/monophp\.sqlite/${project_name}.sqlite/g" "$target_dir/public/index.php"
        sed -i "s/SITE_DOMAIN=localhost:8000/SITE_DOMAIN=${project_name}.test/" "$target_dir/.env"
    fi

    # Ensure directories exist and are clean
    mkdir -p "$target_dir/logs"
    mkdir -p "$target_dir/database"
    mkdir -p "$target_dir/cache"
    rm -f "$target_dir/database/"*.sqlite
    rm -f "$target_dir/logs/"*.log
    touch "$target_dir/database/.gitkeep"
    touch "$target_dir/logs/.gitkeep"
    touch "$target_dir/cache/.gitkeep"

    # Initialize fresh git repository
    echo -e "${YELLOW}➜${NC} Initializing git repository..."
    cd "$target_dir"
    git init --quiet

    # Success message
    echo ""
    echo -e "${GREEN}✓ Project '${project_name}' created successfully!${NC}"
    echo ""
    echo -e "  ${GREEN}✓${NC} Authentication: ${auth_label}"
    echo -e "  ${GREEN}✓${NC} Environment file: .env created"
    echo -e "  ${GREEN}✓${NC} Database: database/${project_name}.sqlite (will be created on first run)"
    echo -e "  ${GREEN}✓${NC} Logs folder: logs/"
    echo -e "  ${GREEN}✓${NC} Cache folder: cache/"
    echo ""
    echo -e "${YELLOW}To start your project:${NC}"
    echo ""
    echo -e "  ${BLUE}cd ${project_name}${NC}"
    echo -e "  ${BLUE}php -S localhost:8000 -t public${NC}"
    echo ""
    echo -e "Then open ${BLUE}http://localhost:8000${NC} in your browser."
    echo ""
}

# Main command handling
case "${1:-}" in
    new)
        create_project "$2"
        ;;
    list|variants)
        list_variants
        ;;
    update)
        update_cli
        ;;
    help|--help|-h)
        show_help
        ;;
    version|--version|-v)
        show_version
        ;;
    "")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'monophp help' for usage"
        exit 1
        ;;
esac
