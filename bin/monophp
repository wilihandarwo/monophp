#!/bin/bash

# MonoPHP Project Generator
# Usage: monophp new <project-name>

set -e

MONOPHP_TEMPLATE_DIR="/Users/wilihandarwo/dev/php/monophp"
VERSION="1.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_logo() {
    echo -e "${BLUE}"
    echo "  __  __                   _____  _    _ _____  "
    echo " |  \/  |                 |  __ \| |  | |  __ \ "
    echo " | \  / | ___  _ __   ___ | |__) | |__| | |__) |"
    echo " | |\/| |/ _ \| '_ \ / _ \|  ___/|  __  |  ___/ "
    echo " | |  | | (_) | | | | (_) | |    | |  | | |     "
    echo " |_|  |_|\___/|_| |_|\___/|_|    |_|  |_|_|     "
    echo -e "${NC}"
    echo "  Single-file PHP Application Generator v${VERSION}"
    echo ""
}

show_help() {
    print_logo
    echo "Usage: monophp <command> [options]"
    echo ""
    echo "Commands:"
    echo "  new <name>     Create a new MonoPHP project"
    echo "  help           Show this help message"
    echo "  version        Show version"
    echo ""
    echo "Examples:"
    echo "  monophp new myapp"
    echo "  monophp new my-awesome-project"
    echo ""
}

show_version() {
    echo "MonoPHP Generator v${VERSION}"
}

create_project() {
    local project_name="$1"
    local target_dir="$(pwd)/${project_name}"

    # Validate project name
    if [[ -z "$project_name" ]]; then
        echo -e "${RED}Error: Project name is required${NC}"
        echo "Usage: monophp new <project-name>"
        exit 1
    fi

    # Check if project name is valid (alphanumeric, hyphens, underscores)
    if [[ ! "$project_name" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
        echo -e "${RED}Error: Invalid project name${NC}"
        echo "Project name must start with a letter and contain only letters, numbers, hyphens, or underscores"
        exit 1
    fi

    # Check if directory already exists
    if [[ -d "$target_dir" ]]; then
        echo -e "${RED}Error: Directory '${project_name}' already exists${NC}"
        exit 1
    fi

    # Check if template directory exists
    if [[ ! -d "$MONOPHP_TEMPLATE_DIR" ]]; then
        echo -e "${RED}Error: MonoPHP template not found at ${MONOPHP_TEMPLATE_DIR}${NC}"
        echo "Please update MONOPHP_TEMPLATE_DIR in this script"
        exit 1
    fi

    print_logo
    echo -e "${GREEN}Creating new MonoPHP project: ${project_name}${NC}"
    echo ""

    # Create project directory
    mkdir -p "$target_dir"

    # Copy template files (excluding .git, .env, database/*.sqlite, logs/*)
    echo -e "${YELLOW}➜${NC} Copying template files..."
    
    # Create directory structure
    mkdir -p "$target_dir/public"
    mkdir -p "$target_dir/database"
    mkdir -p "$target_dir/logs"
    mkdir -p "$target_dir/resources"

    # Copy main application file
    cp "$MONOPHP_TEMPLATE_DIR/public/index.php" "$target_dir/public/index.php"

    # Copy .env.example
    cp "$MONOPHP_TEMPLATE_DIR/.env.example" "$target_dir/.env.example"
    cp "$MONOPHP_TEMPLATE_DIR/.env.example" "$target_dir/.env"

    # Copy .gitignore if exists
    if [[ -f "$MONOPHP_TEMPLATE_DIR/.gitignore" ]]; then
        cp "$MONOPHP_TEMPLATE_DIR/.gitignore" "$target_dir/.gitignore"
    fi

    # Copy README if exists
    if [[ -f "$MONOPHP_TEMPLATE_DIR/README.md" ]]; then
        cp "$MONOPHP_TEMPLATE_DIR/README.md" "$target_dir/README.md"
    fi

    # Copy resources directory contents if any
    if [[ -d "$MONOPHP_TEMPLATE_DIR/resources" ]]; then
        cp -r "$MONOPHP_TEMPLATE_DIR/resources/"* "$target_dir/resources/" 2>/dev/null || true
    fi

    # Copy public/assets if exists
    if [[ -d "$MONOPHP_TEMPLATE_DIR/public/assets" ]]; then
        cp -r "$MONOPHP_TEMPLATE_DIR/public/assets" "$target_dir/public/"
    fi

    # Replace project-specific values
    echo -e "${YELLOW}➜${NC} Configuring project..."

    # Update database filename in index.php
    sed -i '' "s/monophp\.sqlite/${project_name}.sqlite/g" "$target_dir/public/index.php"

    # Update SITE_DOMAIN in .env with project name as placeholder
    sed -i '' "s/SITE_DOMAIN=$/SITE_DOMAIN=${project_name}.test/" "$target_dir/.env"

    # Create empty log file
    touch "$target_dir/logs/app.log"

    # Create .gitkeep files
    touch "$target_dir/database/.gitkeep"
    touch "$target_dir/logs/.gitkeep"

    # Initialize git repository
    echo -e "${YELLOW}➜${NC} Initializing git repository..."
    cd "$target_dir"
    git init --quiet

    echo ""
    echo -e "${GREEN}✓ Project '${project_name}' created successfully!${NC}"
    echo ""
    echo -e "Next steps:"
    echo -e "  ${BLUE}cd ${project_name}${NC}"
    echo -e "  ${BLUE}# Edit .env with your configuration${NC}"
    echo -e "  ${BLUE}# Start PHP built-in server:${NC}"
    echo -e "  ${BLUE}php -S localhost:8000 -t public${NC}"
    echo ""
}

# Main command handling
case "${1:-}" in
    new)
        create_project "$2"
        ;;
    help|--help|-h)
        show_help
        ;;
    version|--version|-v)
        show_version
        ;;
    "")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'monophp help' for usage"
        exit 1
        ;;
esac
