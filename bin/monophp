#!/bin/bash

# MonoPHP Project Generator
# Usage: monophp new <project-name>

set -e

MONOPHP_REPO="https://github.com/wilihandarwo/monophp.git"
VERSION="1.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_logo() {
    echo -e "${BLUE}"
    echo "  __  __                   _____  _    _ _____  "
    echo " |  \/  |                 |  __ \| |  | |  __ \ "
    echo " | \  / | ___  _ __   ___ | |__) | |__| | |__) |"
    echo " | |\/| |/ _ \| '_ \ / _ \|  ___/|  __  |  ___/ "
    echo " | |  | | (_) | | | | (_) | |    | |  | | |     "
    echo " |_|  |_|\___/|_| |_|\___/|_|    |_|  |_|_|     "
    echo -e "${NC}"
    echo "  Single-file PHP Application Generator v${VERSION}"
    echo ""
}

show_help() {
    print_logo
    echo "Usage: monophp <command> [options]"
    echo ""
    echo "Commands:"
    echo "  new <name>     Create a new MonoPHP project"
    echo "  help           Show this help message"
    echo "  version        Show version"
    echo ""
    echo "Examples:"
    echo "  monophp new myapp"
    echo "  monophp new my-awesome-project"
    echo ""
}

show_version() {
    echo "MonoPHP Generator v${VERSION}"
}

create_project() {
    local project_name="$1"
    local target_dir="$(pwd)/${project_name}"

    # Validate project name
    if [[ -z "$project_name" ]]; then
        echo -e "${RED}Error: Project name is required${NC}"
        echo "Usage: monophp new <project-name>"
        exit 1
    fi

    # Check if project name is valid (alphanumeric, hyphens, underscores)
    if [[ ! "$project_name" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
        echo -e "${RED}Error: Invalid project name${NC}"
        echo "Project name must start with a letter and contain only letters, numbers, hyphens, or underscores"
        exit 1
    fi

    # Check if directory already exists
    if [[ -d "$target_dir" ]]; then
        echo -e "${RED}Error: Directory '${project_name}' already exists${NC}"
        exit 1
    fi

    # Check for git
    if ! command -v git &> /dev/null; then
        echo -e "${RED}Error: git is required but not installed${NC}"
        exit 1
    fi

    print_logo
    echo -e "${GREEN}Creating new MonoPHP project: ${project_name}${NC}"
    echo ""

    # Clone from GitHub
    echo -e "${YELLOW}➜${NC} Downloading MonoPHP template..."
    git clone --quiet --depth 1 "$MONOPHP_REPO" "$target_dir"

    # Remove .git directory from template and reinitialize
    rm -rf "$target_dir/.git"

    # Remove CLI-related files (not needed in new projects)
    rm -rf "$target_dir/bin"
    rm -f "$target_dir/install.sh"
    rm -f "$target_dir/CLAUDE.md"
    rm -f "$target_dir/WARP.md"

    # Prompt for authentication variant
    echo ""
    echo -e "${YELLOW}Select authentication method:${NC}"
    echo ""
    echo -e "  ${BLUE}1)${NC} Email & Password"
    echo -e "  ${BLUE}2)${NC} Google OAuth"
    echo ""
    read -p "Enter choice [1-2]: " auth_choice

    case "$auth_choice" in
        1)
            echo -e "${YELLOW}➜${NC} Using Email & Password authentication..."
            cp "$target_dir/resources/index-variant/index-emailpass-sidebar.php" "$target_dir/public/index.php"
            ;;
        2)
            echo -e "${YELLOW}➜${NC} Using Google OAuth authentication..."
            cp "$target_dir/resources/index-variant/index-googleoauth.php" "$target_dir/public/index.php"
            ;;
        *)
            echo -e "${YELLOW}➜${NC} Invalid choice, defaulting to Email & Password..."
            cp "$target_dir/resources/index-variant/index-emailpass-sidebar.php" "$target_dir/public/index.php"
            ;;
    esac

    # Remove variant files (not needed in new projects)
    rm -rf "$target_dir/resources/index-variant"

    # Create .env from .env.example
    cp "$target_dir/.env.example" "$target_dir/.env"

    # Replace project-specific values
    echo -e "${YELLOW}➜${NC} Configuring project..."

    # Update database filename in index.php (cross-platform sed)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "s/monophp\.sqlite/${project_name}.sqlite/g" "$target_dir/public/index.php"
        sed -i '' "s/SITE_DOMAIN=$/SITE_DOMAIN=${project_name}.test/" "$target_dir/.env"
    else
        sed -i "s/monophp\.sqlite/${project_name}.sqlite/g" "$target_dir/public/index.php"
        sed -i "s/SITE_DOMAIN=$/SITE_DOMAIN=${project_name}.test/" "$target_dir/.env"
    fi

    # Clear logs and database (start fresh)
    rm -f "$target_dir/database/"*.sqlite
    rm -f "$target_dir/logs/"*.log
    touch "$target_dir/logs/app.log"
    touch "$target_dir/database/.gitkeep"
    touch "$target_dir/logs/.gitkeep"

    # Initialize fresh git repository
    echo -e "${YELLOW}➜${NC} Initializing git repository..."
    cd "$target_dir"
    git init --quiet

    echo ""
    echo -e "${GREEN}✓ Project '${project_name}' created successfully!${NC}"
    echo ""
    echo -e "Next steps:"
    echo -e "  ${BLUE}cd ${project_name}${NC}"
    echo -e "  ${BLUE}# Edit .env with your configuration${NC}"
    echo -e "  ${BLUE}# Start PHP built-in server:${NC}"
    echo -e "  ${BLUE}php -S localhost:8000 -t public${NC}"
    echo ""
}

# Main command handling
case "${1:-}" in
    new)
        create_project "$2"
        ;;
    help|--help|-h)
        show_help
        ;;
    version|--version|-v)
        show_version
        ;;
    "")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'monophp help' for usage"
        exit 1
        ;;
esac
