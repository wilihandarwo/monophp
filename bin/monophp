#!/bin/bash

# MonoPHP Project Generator
# Usage: monophp new <project-name>

set -e

MONOPHP_REPO="https://github.com/wilihandarwo/monophp.git"
VERSION="1.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_logo() {
    echo -e "${BLUE}"
    echo "  __  __                   _____  _    _ _____  "
    echo " |  \/  |                 |  __ \| |  | |  __ \ "
    echo " | \  / | ___  _ __   ___ | |__) | |__| | |__) |"
    echo " | |\/| |/ _ \| '_ \ / _ \|  ___/|  __  |  ___/ "
    echo " | |  | | (_) | | | | (_) | |    | |  | | |     "
    echo " |_|  |_|\___/|_| |_|\___/|_|    |_|  |_|_|     "
    echo -e "${NC}"
    echo "  Single-file PHP Application Generator v${VERSION}"
    echo ""
}

show_help() {
    print_logo
    echo "Usage: monophp <command> [options]"
    echo ""
    echo "Commands:"
    echo "  new <name>     Create a new MonoPHP project"
    echo "  help           Show this help message"
    echo "  version        Show version"
    echo ""
    echo "Examples:"
    echo "  monophp new myapp"
    echo "  monophp new my-awesome-project"
    echo ""
}

show_version() {
    echo "MonoPHP Generator v${VERSION}"
}

# Interactive menu with arrow key navigation
select_option() {
    local options=("$@")
    local selected=0
    local count=${#options[@]}

    # Hide cursor
    tput civis

    # Ensure cursor is restored on exit
    trap 'tput cnorm' EXIT

    while true; do
        # Print options
        for i in "${!options[@]}"; do
            if [[ $i -eq $selected ]]; then
                echo -e "  ${GREEN}▸ ${options[$i]}${NC}"
            else
                echo -e "    ${options[$i]}"
            fi
        done

        # Read single key
        read -rsn1 key

        # Handle arrow keys (escape sequences)
        if [[ $key == $'\x1b' ]]; then
            read -rsn2 key
            case $key in
                '[A') # Up arrow
                    ((selected--)) || true
                    [[ $selected -lt 0 ]] && selected=$((count - 1))
                    ;;
                '[B') # Down arrow
                    ((selected++)) || true
                    [[ $selected -ge $count ]] && selected=0
                    ;;
            esac
        elif [[ $key == "" ]]; then  # Enter key
            break
        fi

        # Move cursor up to redraw
        tput cuu $count
    done

    # Show cursor
    tput cnorm

    # Return selected index
    return $selected
}

create_project() {
    local project_name="$1"
    local target_dir="$(pwd)/${project_name}"

    # Validate project name
    if [[ -z "$project_name" ]]; then
        echo -e "${RED}Error: Project name is required${NC}"
        echo "Usage: monophp new <project-name>"
        exit 1
    fi

    # Check if project name is valid (alphanumeric, hyphens, underscores)
    if [[ ! "$project_name" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
        echo -e "${RED}Error: Invalid project name${NC}"
        echo "Project name must start with a letter and contain only letters, numbers, hyphens, or underscores"
        exit 1
    fi

    # Check if directory already exists
    if [[ -d "$target_dir" ]]; then
        echo -e "${RED}Error: Directory '${project_name}' already exists${NC}"
        exit 1
    fi

    # Check for git
    if ! command -v git &> /dev/null; then
        echo -e "${RED}Error: git is required but not installed${NC}"
        exit 1
    fi

    print_logo
    echo -e "${GREEN}Creating new MonoPHP project: ${project_name}${NC}"
    echo ""

    # Clone from GitHub
    echo -e "${YELLOW}➜${NC} Downloading MonoPHP template..."
    git clone --quiet --depth 1 "$MONOPHP_REPO" "$target_dir"

    # Remove .git directory from template and reinitialize
    rm -rf "$target_dir/.git"

    # Remove CLI-related files (not needed in new projects)
    rm -rf "$target_dir/bin"
    rm -f "$target_dir/install.sh"
    rm -f "$target_dir/CLAUDE.md"
    rm -f "$target_dir/WARP.md"

    # Prompt for authentication variant
    echo ""
    echo -e "${YELLOW}Select authentication method:${NC}  ${BLUE}(↑↓ to move, Enter to select)${NC}"
    echo ""

    select_option "Email & Password" "Google OAuth"
    auth_choice=$?

    echo ""
    if [[ $auth_choice -eq 0 ]]; then
        echo -e "${YELLOW}➜${NC} Using Email & Password authentication..."
        cp "$target_dir/resources/index-variant/index-emailpass-sidebar.php" "$target_dir/public/index.php"
    else
        echo -e "${YELLOW}➜${NC} Using Google OAuth authentication..."
        cp "$target_dir/resources/index-variant/index-googleoauth.php" "$target_dir/public/index.php"
    fi

    # Remove variant files (not needed in new projects)
    rm -rf "$target_dir/resources/index-variant"

    # Create .env from .env.example
    cp "$target_dir/.env.example" "$target_dir/.env"

    # Replace project-specific values
    echo -e "${YELLOW}➜${NC} Configuring project..."

    # Update database filename in index.php (cross-platform sed)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "s/monophp\.sqlite/${project_name}.sqlite/g" "$target_dir/public/index.php"
        sed -i '' "s/SITE_DOMAIN=$/SITE_DOMAIN=${project_name}.test/" "$target_dir/.env"
    else
        sed -i "s/monophp\.sqlite/${project_name}.sqlite/g" "$target_dir/public/index.php"
        sed -i "s/SITE_DOMAIN=$/SITE_DOMAIN=${project_name}.test/" "$target_dir/.env"
    fi

    # Ensure directories exist and are clean
    mkdir -p "$target_dir/logs"
    mkdir -p "$target_dir/database"
    rm -f "$target_dir/database/"*.sqlite
    rm -f "$target_dir/logs/"*.log
    touch "$target_dir/database/.gitkeep"
    touch "$target_dir/logs/.gitkeep"

    # Initialize fresh git repository
    echo -e "${YELLOW}➜${NC} Initializing git repository..."
    cd "$target_dir"
    git init --quiet

    # Success message
    echo ""
    echo -e "${GREEN}✓ Project '${project_name}' created successfully!${NC}"
    echo ""
    echo -e "  ${GREEN}✓${NC} Authentication: $(if [[ $auth_choice -eq 0 ]]; then echo 'Email & Password'; else echo 'Google OAuth'; fi)"
    echo -e "  ${GREEN}✓${NC} Environment file: .env created"
    echo -e "  ${GREEN}✓${NC} Database: database/${project_name}.sqlite (will be created on first run)"
    echo -e "  ${GREEN}✓${NC} Logs folder: logs/"
    echo ""
    echo -e "${YELLOW}To start your project:${NC}"
    echo ""
    echo -e "  ${BLUE}cd ${project_name}${NC}"
    echo -e "  ${BLUE}php -S localhost:8000 -t public${NC}"
    echo ""
    echo -e "Then open ${BLUE}http://localhost:8000${NC} in your browser."
    echo ""
}

# Main command handling
case "${1:-}" in
    new)
        create_project "$2"
        ;;
    help|--help|-h)
        show_help
        ;;
    version|--version|-v)
        show_version
        ;;
    "")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'monophp help' for usage"
        exit 1
        ;;
esac
